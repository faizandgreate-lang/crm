<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Care-Pro Riyadh Accommodation</title>
<style>
  body { font-family: "Poppins", Arial, sans-serif; margin: 20px; background: linear-gradient(135deg,#f8f9fa,#e9ecef); color:#222; }
  h1 { text-align:center; color:#004085; font-size:28px; margin-bottom:15px;}
  table{border-collapse:collapse;width:100%;margin:15px 0;background:#fff;border-radius:6px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  th,td{border:1px solid #ddd;padding:8px 10px;text-align:left;font-size:14px;position:relative;}
  th{background:#004085;color:#fff;text-transform:uppercase;cursor:pointer;}
  tr:nth-child(even){background:#f8f9fa}
  .form{border:1px solid #ccc;padding:12px;background:#fff;border-radius:8px;margin-top:10px}
  .form input{margin:5px;padding:6px 10px;border:1px solid #bbb;border-radius:4px}
  .form button{background:#004085;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;margin:5px}
  .hidden{display:none}
  .footer{text-align:center;margin-top:30px;color:#555;font-style:italic}
  .dropdown { display:none; position:absolute; background:#fff; border:1px solid #ccc; border-radius:4px; top:100%; left:0; z-index:10; padding:5px; max-height:200px; overflow:auto; width:150px; box-shadow:0 2px 6px rgba(0,0,0,.1);}
  .dropdown label { display:block; font-size:13px; cursor:pointer; margin:3px 0; color:#000; }
  .filter-arrow::after { content:"‚ñº"; font-size:10px; margin-left:6px; color:#fff; }
  @media (max-width:768px){table,th,td{font-size:12px}.form input,button{width:100%;display:block}}
  /* layout for summary + chart */
  .summary-chart { display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start; }
  .summary-chart > .box { flex:1; min-width:300px; background:transparent; }
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<body>
<!-- üîÑ Loading Screen -->
<div id="loadingScreen" style="
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:#f8f9fa; display:flex; justify-content:center; align-items:center;
  z-index:9999; flex-direction:column;">
  
<img src="https://i.ibb.co/N0Bdr5N/Care-Pro-Logo-Jan-2025-Transparent.png"
     alt="Care-Pro Logo"
     style="width:450px; height:auto; margin-bottom:20px;">
  <p style="font-size:18px; color:#004085; font-weight:600;">Loading...</p>
</div>


<h1> CARE-PRO ACCOMMODATION</h1>

<!-- Care-Pro Logo -->
<!-- Breathing Logo -->
<div style="text-align:center; margin-bottom:20px;">
  <img src="https://i.ibb.co/N0Bdr5N/Care-Pro-Logo-Jan-2025-Transparent.png"
       alt="Care-Pro Logo"
       class="breathing-logo"
       style="height:90px; width:auto; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.2);">
</div>

<style>
/* Breathing animation */
@keyframes breathe {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1); /* 10% bigger at peak */
  }
}

.breathing-logo {
  animation: breathe 2s ease-in-out infinite;
}
</style>



<!-- === Top Control Bar === -->
<div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
  
  <!-- Left: Login / Logout -->
  <div>
    <span id="loginBox">
      <input type="text" id="loginUser" placeholder="User ID">
      <input type="password" id="loginPw" placeholder="Password">
      <button onclick="login()">Login</button>
    </span>

    <span id="adminBox" class="hidden">
      <button onclick="logout()">Logout</button>
    </span>
  </div>

<!-- Right: Make CV + Password -->
<div style="display:flex; align-items:center; gap:10px;">
  <a href="https://linux-aios.github.io/care-pro-cv-generator-by-faizan/" target="_blank">
    <button style="background:#198754;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;">
      Make CV
    </button>
  </a>
  <a href="https://faizandgreate-lang.github.io/Free-pool/" target="_blank">
    <button style="background:#6f42c1;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;">
      Free Pool
    </button>
  </a>


    <div id="passwordBox" style="text-align:right;">
      <label style="font-weight:600; color:#004085;">
        Password:
        <input type="password" id="masterPw" placeholder="Enter Password"
               style="margin-left:6px; padding:4px 8px; border:1px solid #bbb; border-radius:4px;">
      </label>
      <button onclick="verifyMaster()" 
              style="background:#004085; color:#fff; border:none; padding:5px 10px; border-radius:4px; margin-left:6px; cursor:pointer;">
        Verify
      </button>
        <p id="masterMsg" style="color:green; font-weight:600; margin-top:5px;"></p>
</div>
    </div>
  </div>
</div>

<div id="editor" class="form hidden">
  <h4>‚öôÔ∏è ADMIN PANEL</h4>

  <label>IQAMA: <input id="f_iq"></label>
  <label>Name: <input id="f_name"></label>
  <label>Camp: <input id="f_camp" placeholder="CP 1 / CP 2 / CP 3"></label>
  <label>Company: <input id="f_company"></label>
  <label>Gender: <input id="f_gender"></label>
  <label>Nationality: <input id="f_nationality"></label>
  <label>Sponsor: <input id="f_sponsor"></label>
  <label>Room No: <input id="f_room"></label>
  <br>
  <button onclick="addWorker()">Add Worker</button>
  <button onclick="deleteWorkerPrompt()">Delete Worker</button>
  <div id="msg" style="color:green;margin-top:8px;font-weight:600;"></div>

  <!-- === Export Section (Visible to Everyone) === -->
<h4>üì§ Export Workers</h4>
<button onclick="exportCSV()">Export Workers CSV</button>
<p style="font-size:12px;color:gray">
  CSV Format: iq,name,camp,company,gender,nationality,sponsor,room
</p>

<!-- === Hidden Section (Visible only after Master Password) === -->
<div id="masterHiddenSection" class="hidden" style="margin-top:20px;">

  <h4> Manage Camps</h4>
  <input id="newCampName" placeholder="Enter Camp Name">
  <button onclick="addNewCamp()">Add Camp</button>
  <button onclick="deleteCamp()">Delete Camp</button>

  <h4>üì• Import Workers</h4>
  <input type="file" id="csvFile" accept=".csv">
  <button onclick="importCSV()">Import CSV</button>


  <div id="masterControls" class="hidden" style="margin-top:12px;">
    <button onclick="addWorkerColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">‚ûï Add Column</button>
    <button onclick="deleteWorkerColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">üóë Delete Column</button>
    <button onclick="saveWorkerColumns()" style="margin:5px;padding:6px 12px;background:#198754;color:#fff;border:none;border-radius:4px;cursor:pointer;">üíæ Save Changes</button>
  </div>
</div>


<div id="masterControls" class="hidden" style="margin-top:8px;">
  <button onclick="addWorkerColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">‚ûï Add Column</button>
  <button onclick="deleteWorkerColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">üóë Delete Column</button>
  <button onclick="saveWorkerColumns()" style="margin:5px;padding:6px 12px;background:#198754;color:#fff;border:none;border-radius:4px;cursor:pointer;">üíæ Save Changes</button>
</div>

</div>

<h2> Select Camp</h2>
<div style="margin:10px 0;">
  <label>Camp:
    <select id="campSelect" onchange="showSelectedCamp()"></select>
  </label>
  <button onclick="showSelectedCamp()">Show Camp</button>
</div>

<div class="search-box">
  <h3>üîç Search Worker by IQAMA</h3>
  <input type="text" id="searchIqama" placeholder="Enter IQAMA Number">
  <button onclick="searchByIqama()">Search</button>
  <div id="searchResult" style="margin-top:10px;"></div>
</div>

<!-- Client Summary + Chart -->
<!--  Client / Company Summary + Chart -->
<div class="summary-chart" style="margin-top:12px;">
  <div id="clientSummaryBox" class="box">
    <h2> Client / Company Summary</h2>
    <div style="margin-bottom:10px;">
      <label>Filter by Company:
        <select id="filterCompany" onchange="renderClientSummary()">
          <option value="">All Companies</option>
        </select>
      </label>
    </div>
    <div id="clientSummary"></div>
  </div>
  <div id="clientChartBox" class="box">
    <h2> Worker Count Graph</h2>
    <canvas id="clientChart" height="300"></canvas>
  </div>
</div>

<h2> Camp Summary</h2>
<div id="campSummary"></div>

<h2> Worker Details</h2>
<div id="tableWrap"></div>

<!-- optional admin worker column controls (if you used previously) -->
<div id="workerColumnControls" class="hidden" style="margin-top:8px;">
  <button onclick="addWorkerColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">‚ûï Add Column</button>
  <button onclick="deleteWorkerColumn()" style="margin:5px;padding:6px 12px;background:#004085;color:#fff;border:none;border-radius:4px;cursor:pointer;">üóë Delete Column</button>
  <button onclick="saveWorkerColumns()" style="margin:5px;padding:6px 12px;background:#198754;color:#fff;border:none;border-radius:4px;cursor:pointer;">üíæ Save Changes</button>
</div>

<div class="footer">Made with ‚ù§Ô∏è by <span>Faizan Khan</span></div>

<script>
const ADMIN_PASSWORD = '12341234';
let isAdmin = false;
let workers = [];
let camps = [];
let campData = {};
let activeFilters = {};
let clientChartInstance = null;
  
  // === CAMP USER LOGIN CREDENTIALS ===
const CAMP_USERS = {
  "New bawadi": { user: "bawadi1", pass: "1234" },
  "G. Bawadi": { user: "cp1", pass: "cp1pass" },
  "Old rabwa": { user: "cp2", pass: "cp2pass" },
  "B.sultan": { user: "cp3", pass: "cp3pass" }
};


// ---------- API Save / Load ----------
async function apiGetData() {
  try {
    const r = await fetch('/api/saveData');
    if(!r.ok) throw new Error('Failed to load data');
    return await r.json();
  } catch(e){ console.error(e); alert('Error loading data.'); return {workers:[], camps:[], campData:{}}; }
}
async function apiSaveData() {
  try {
    const r = await fetch('/api/saveData', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({workers, camps, campData})
    });
    const j = await r.json();
    if(!r.ok) throw new Error(j.message||'Save failed');
    return j;
  } catch(e){ console.error(e); alert('Error saving data'); return null; }
}

// ---------- Admin Login ----------
let currentUserCamp = null;

function login() {
  const user = document.getElementById("loginUser").value.trim();
  const pw   = document.getElementById("loginPw").value.trim();

  // --- Admin login ---
  if (pw === ADMIN_PASSWORD) {
    isAdmin = true;
    currentUserCamp = null;
    editor.classList.remove('hidden');
    loginBox.classList.add('hidden');
    adminBox.classList.remove('hidden');
    msg.innerText = "‚úÖ Admin mode enabled";
    renderAll();
    return;
  }

  // --- Camp-specific user login ---
  const campEntry = Object.entries(CAMP_USERS).find(([camp, creds]) =>
    creds.user === user && creds.pass === pw
  );

  if (campEntry) {
    const [campName] = campEntry;
    isAdmin = false;
    currentUserCamp = campName;
    editor.classList.remove('hidden');
    loginBox.classList.add('hidden');
    adminBox.classList.remove('hidden');
    msg.innerText = `‚úÖ Logged in as ${user} (Camp: ${campName})`;
    renderTable(campName);
    return;
  }

  alert("‚ùå Invalid login credentials!");
}

function logout(){
  isAdmin=false;
  editor.classList.add('hidden');
  loginBox.classList.remove('hidden');
  adminBox.classList.add('hidden');
  renderAll();
}

// ---------- Workers Table ----------
function addWorker() {
  const w = {
    iq: f_iq.value.trim(),
    name: f_name.value.trim(),
    camp: f_camp.value.trim(),
    company: f_company.value.trim(),
    gender: f_gender.value.trim(),
    nationality: f_nationality.value.trim(),
    sponsor: f_sponsor.value.trim(),
    room: f_room.value.trim()
  };

  if (!w.iq || !w.name) return alert("IQAMA and Name required!");

  // Restrict to user‚Äôs camp
  if (!isAdmin && currentUserCamp && w.camp !== currentUserCamp)
    return alert(`‚ùå You can only add workers to your own camp: "${currentUserCamp}"`);

  workers.push(w);
  apiSaveData().then(r => { if (r) { msg.innerText = "‚úÖ Worker added!"; renderAll(); } });
}

function deleteWorkerPrompt() {
  const iq = prompt("Enter IQAMA to delete:");
  if (!iq) return;

  const index = workers.findIndex(w => w.iq === iq);
  if (index < 0) return alert("‚ùå IQAMA not found!");

  const worker = workers[index];

  // Allow delete if:
  // (1) Admin logged in, OR
  // (2) Master password verified
  const masterVerified =
    document.getElementById('masterMsg')?.innerText.toLowerCase().includes('verified');

  // --- Case 1: Admin or Master Password ---
  if (isAdmin || masterVerified) {
    if (confirm(`üóëÔ∏è Delete worker "${worker.name}" from camp "${worker.camp}"?`)) {
      workers.splice(index, 1);
      apiSaveData().then(r => {
        if (r) {
          alert("‚úÖ Worker deleted!");
          renderAll();
        }
      });
    }
    return;
  }

  // --- Case 2: Camp user (non-admin, no master) ---
  if (currentUserCamp && worker.camp !== currentUserCamp) {
    alert(`‚ùå You can only delete workers from your own camp: "${currentUserCamp}"`);
    return;
  }

  // --- Allow delete only from their camp ---
  if (confirm(`üóëÔ∏è Delete worker "${worker.name}" from camp "${worker.camp}"?`)) {
    workers.splice(index, 1);
    apiSaveData().then(r => {
      if (r) {
        alert("‚úÖ Worker deleted!");
        renderAll();
      }
    });
  }
}

function updateCampDropdown(){
  campSelect.innerHTML='';
  camps.forEach(c=>{const o=document.createElement('option'); o.value=c; o.innerText=c; campSelect.appendChild(o);});
}
function renderTable(campFilter=''){
  let filtered = workers.filter(w=>(!campFilter||w.camp===campFilter));
  Object.keys(activeFilters).forEach(k=>{
    if(activeFilters[k]?.length>0){
      filtered = filtered.filter(w=>activeFilters[k].includes((w[k]||'').toString()));
    }
  });
  let html = `<table><thead><tr>
    <th>#</th><th>IQAMA</th><th>Name</th>
    <th class='filter-arrow' onclick="toggleDropdown('camp')">Camp<div id='drop-camp' class='dropdown'></div></th>
    <th class='filter-arrow' onclick="toggleDropdown('company')">Company<div id='drop-company' class='dropdown'></div></th>
    <th class='filter-arrow' onclick="toggleDropdown('gender')">Gender<div id='drop-gender' class='dropdown'></div></th>
    <th class='filter-arrow' onclick="toggleDropdown('nationality')">Nationality<div id='drop-nationality' class='dropdown'></div></th>
    <th class='filter-arrow' onclick="toggleDropdown('sponsor')">Sponsor<div id='drop-sponsor' class='dropdown'></div></th>
    <th>Room</th></tr></thead><tbody>`;
  let count=1;
  filtered.forEach(w=>{
    html+=`<tr><td>${count++}</td><td>${w.iq}</td><td>${w.name}</td><td>${w.camp}</td><td>${w.company}</td><td>${w.gender}</td><td>${w.nationality}</td><td>${w.sponsor}</td><td>${w.room}</td></tr>`;
  });
  html+='</tbody></table>';
  tableWrap.innerHTML=html;
  // worker column controls shown only for admin (if used)
  const ctrl = document.getElementById('workerColumnControls');
  if (ctrl) ctrl.classList.toggle('hidden', !isAdmin);

  buildDropdowns();
}
function buildDropdowns() {
  const keys = ['camp', 'company', 'gender', 'nationality', 'sponsor'];
  keys.forEach(k => {
    const drop = document.getElementById('drop-' + k);
    if (!drop) return;

    // Ensure worker data exists before building
    if (!workers || workers.length === 0) {
      drop.innerHTML = "<em style='color:#888;font-size:12px;'>No workers</em>";
      return;
    }

    // Get all unique values for this column
    const values = [...new Set(
      workers.map(w => (w[k] || '').trim()).filter(v => v && v !== '.')
    )].sort();

    // If still empty, show no-data text
    if (values.length === 0) {
      drop.innerHTML = "<em style='color:#888;font-size:12px;'>No data</em>";
      return;
    }

    // Build dropdown list with checkboxes
    let html = `<label><input type='checkbox' value='' onchange='filterChange("${k}", this)'> All</label>`;
    values.forEach(v => {
      const checked = activeFilters[k]?.includes(v) ? 'checked' : '';
      html += `<label><input type='checkbox' value='${v}' ${checked} onchange='filterChange("${k}", this)'> ${v}</label>`;
    });
    drop.innerHTML = html;
  });
}

function toggleDropdown(k){
  const el=document.getElementById('drop-'+k);
  document.querySelectorAll('.dropdown').forEach(d=>{if(d!==el)d.style.display='none';});
  el.style.display=(el.style.display==='block')?'none':'block';
}
window.onclick=function(e){if(!e.target.closest('th')) document.querySelectorAll('.dropdown').forEach(d=>d.style.display='none');};
function filterChange(k, el){
  const val=el.value;
  activeFilters[k]=activeFilters[k]||[];
  if(val===''){activeFilters[k]=[]; renderTable(); return;}
  if(el.checked) activeFilters[k].push(val);
  else activeFilters[k]=activeFilters[k].filter(v=>v!==val);
  renderTable();
}

// ---------- Client Summary (table + chart) ----------
function renderClientSummary(){
  // === Build unique company list ===
  const companySet = new Set(workers.map(w => w.company).filter(Boolean));
  const companySelect = document.getElementById("filterCompany");

  // Populate dropdown once
  if (companySelect && companySelect.options.length <= 1) {
    companySet.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      companySelect.appendChild(opt);
    });
  }

  const selectedCompany = companySelect?.value || "";

  // === Filter workers if company is selected ===
  let filteredWorkers = workers;
  if (selectedCompany) {
    filteredWorkers = filteredWorkers.filter(w => w.company === selectedCompany);
  }

  // === Build table data ===
  const map = {};
  filteredWorkers.forEach(w => {
    const comp = w.company || "Unknown";
    if (!map[comp]) map[comp] = {};
    map[comp][w.camp] = (map[comp][w.camp] || 0) + 1;
  });

  let html = '<table><tr><th>Company</th>';
  camps.forEach(c => html += `<th>${c}</th>`);
  html += '<th>Total</th></tr>';

  let total = 0;
  for (const comp in map) {
    let sum = 0;
    html += `<tr><td>${comp}</td>`;
    camps.forEach(c => {
      const val = map[comp][c] || 0;
      sum += val;
      html += `<td>${val}</td>`;
    });
    html += `<td>${sum}</td></tr>`;
    total += sum;
  }

  html += `<tr style="font-weight:bold;background:#cfe2ff;">
    <td>Total</td>
    ${camps.map(()=>'<td></td>').join('')}
    <td>${total}</td>
  </tr></table>`;

  clientSummary.innerHTML = html;

  // === Build chart ===
  const labels = Object.keys(map);
  const data = labels.map(lbl => {
    let s=0; camps.forEach(cp => { s += map[lbl][cp]||0; });
    return s;
  });

  if (clientChartInstance) clientChartInstance.destroy();
  const ctx = document.getElementById('clientChart').getContext('2d');
  clientChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Workers',
        data,
        backgroundColor: '#004085'
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { precision:0 } } }
    }
  });
}


// ---------- Camp Summary (Editable / Add Row / Column) ----------
function getSavedHeaders(){
  return (campData && Array.isArray(campData.__summaryHeaders) && campData.__summaryHeaders.length>0)
    ? campData.__summaryHeaders.slice()
    : ['Camp','Rooms','Total Beds','Available Beds','Male','Female','Total'];
}
function renderCampSummary() {
  const headers = getSavedHeaders();
  let html = '<table id="campSummaryTable"><thead><tr>';
  headers.forEach(h => {
    html += `<th contenteditable="true">${h}</th>`;
  });
  html += '</tr></thead><tbody>';

  let totalWorkers = 0;
  camps.forEach(c => {
    const total = workers.filter(w => w.camp === c).length;
    const male = workers.filter(w => w.camp === c && (w.gender || '').toLowerCase().startsWith('m')).length;
    const female = workers.filter(w => w.camp === c && (w.gender || '').toLowerCase().startsWith('f')).length;
    const data = campData[c] || { beds: 0, rooms: 0, meta: {} };
    const avail = Math.max((Number(data.beds) || 0) - total, 0);
    totalWorkers += total;

    html += '<tr>';
    headers.forEach(h => {
      const key = h.trim().toLowerCase();
      let val = '';
      if (key === 'camp') val = c;
      else if (key === 'rooms' || key === 'room') val = data.rooms || 0;
      else if (key === 'total beds' || key === 'beds' || key === 'total_beds') val = data.beds || 0;
      else if (key === 'available beds' || key === 'available') val = avail;
      else if (key === 'male') val = male;
      else if (key === 'female') val = female;
      else if (key === 'total') val = total;
      else val = (data.meta && data.meta[h]) !== undefined ? data.meta[h] : '';
      html += `<td contenteditable="true">${val}</td>`;
    });
    html += '</tr>';
  });

  html += `<tr style="font-weight:bold;background:#cfe2ff;">
    <td colspan="${Math.max(1, headers.length - 1)}">Total Workers</td>
    <td>${totalWorkers}</td>
  </tr>`;
  html += '</tbody></table>';

  html += `
    <div id="campControls" class="hidden" style="margin-top:8px;">
      <button id="addRowBtn">‚ûï Add Row</button>
      <button id="deleteRowBtn">üóë Delete Row</button>
      <button id="addColBtn">‚ûï Add Column</button>
      <button id="deleteColBtn">üóë Delete Column</button>
      <button id="saveBtn">üíæ Save Changes</button>
    </div>`;

  campSummary.innerHTML = html;

  // re-bind events
  document.getElementById('addRowBtn').onclick = addRow;
  document.getElementById('deleteRowBtn').onclick = deleteRow;
  document.getElementById('addColBtn').onclick = addColumn;
  document.getElementById('deleteColBtn').onclick = deleteColumn;
  document.getElementById('saveBtn').onclick = saveCampSummary;
}

// Add new empty row before the total
function addRow() {
  const tbl = document.getElementById('campSummaryTable');
  if (!tbl) return alert('Camp summary table not found.');
  const tbody = tbl.tBodies[0];
  const colCount = tbl.tHead.rows[0].cells.length;
  const row = tbody.insertRow(tbody.rows.length - 1);
  for (let i = 0; i < colCount; i++) {
    const cell = row.insertCell(i);
    cell.contentEditable = "true";
    cell.innerText = i === 0 ? "New Camp" : "";
  }
}

function deleteRow() {
  const tbl = document.getElementById('campSummaryTable');
  if (!tbl) return alert('Camp summary table not found.');
  const tbody = tbl.tBodies[0];
  if (tbody.rows.length <= 2) return alert('Cannot delete last row.');
  tbody.deleteRow(tbody.rows.length - 2); // before total
}

function addColumn() {
  const tbl = document.getElementById('campSummaryTable');
  if (!tbl) return alert('Camp summary table not found.');
  const th = document.createElement('th');
  th.contentEditable = "true";
  th.innerText = 'New Column';
  tbl.tHead.rows[0].appendChild(th);
  for (let r = 0; r < tbl.tBodies[0].rows.length; r++) {
    const row = tbl.tBodies[0].rows[r];
    const cell = row.insertCell();
    cell.contentEditable = "true";
    cell.innerText = "";
  }
}

function deleteColumn() {
  const tbl = document.getElementById('campSummaryTable');
  if (!tbl) return alert('Camp summary table not found.');
  const colCount = tbl.tHead.rows[0].cells.length;
  if (colCount <= 2) return alert('Cannot delete essential columns.');
  for (let r = 0; r < tbl.rows.length; r++) {
    const row = tbl.rows[r];
    row.deleteCell(colCount - 1);
  }
}

function saveCampSummary() {
  const tbl = document.getElementById('campSummaryTable');
  if (!tbl) return alert('Nothing to save.');
  const headers = Array.from(tbl.tHead.rows[0].cells).map(th => th.innerText.trim() || 'Column');
  const rows = [];
  const tbody = tbl.tBodies[0];
  for (let r = 0; r < tbody.rows.length; r++) {
    const row = tbody.rows[r];
    if (row.innerText.includes('Total Workers')) break;
    const cells = Array.from(row.cells).map(td => td.innerText.trim());
    if (!cells[0]) continue;
    rows.push(cells);
  }

  const newCamps = [];
  const newCampData = {};
  rows.forEach(cells => {
    const name = cells[0].trim();
    if (!name) return;
    newCamps.push(name);
    const entry = { beds: 0, rooms: 0, meta: {} };
    for (let i = 1; i < headers.length; i++) {
      const h = headers[i].toLowerCase();
      const v = cells[i] || '';
      if (h.includes('room')) entry.rooms = Number(v) || 0;
      else if (h.includes('bed')) entry.beds = Number(v) || 0;
      else entry.meta[headers[i]] = v;
    }
    newCampData[name] = entry;
  });

  newCampData.__summaryHeaders = headers;
  camps = newCamps;
  campData = newCampData;

  apiSaveData().then(res => {
    if (res) {
      alert('‚úÖ Camp summary saved successfully!');
      updateCampDropdown();
      renderAll();
    } else {
      alert('‚ö†Ô∏è Save failed.');
    }
  });
}

// ---------- CSV ----------
function exportCSV(){
  if(workers.length===0) return alert("No data to export!");
  const h=["iq","name","camp","company","gender","nationality","sponsor","room"];
  const r=workers.map(w=>h.map(x=>`"${(w[x]||"").replace(/"/g,'""')}"`).join(","));
  const csv=h.join(",")+"\n"+r.join("\n");
  const b=new Blob([csv],{type:"text/csv"});
  const u=URL.createObjectURL(b);
  const a=document.createElement("a"); a.href=u; a.download="workers.csv"; a.click(); URL.revokeObjectURL(u);
}
function importCSV(){
  const f=document.getElementById("csvFile").files[0]; if(!f) return alert("Select CSV file!");
  const r=new FileReader();
  r.onload=function(e){
    const lines=e.target.result.split("\n").map(l=>l.trim()).filter(l=>l);
    const headers=lines.shift().split(",").map(h=>h.trim().replace(/"/g,""));
    const nw=lines.map(l=>{const v=l.split(",").map(x=>x.replace(/^"|"$/g,"").trim()); const o={}; headers.forEach((h,i)=>o[h]=v[i]||""); return o; });
    if(confirm(`Import ${nw.length} workers?`)){ workers=nw; apiSaveData().then(x=>{if(x){alert("‚úÖ CSV Imported!"); renderAll();}});}
  };
  r.readAsText(f);
}

// ---------- Helpers ----------
async function loadData(){
  const d=await apiGetData();
  workers=d.workers||[]; camps=d.camps||[]; campData=d.campData||{};
  updateCampDropdown(); renderAll();
}
function renderAll(){updateCampDropdown(); renderTable(); renderClientSummary(); renderCampSummary();}
function showSelectedCamp(){const s=campSelect.value; if(s) renderTable(s); else renderTable();}

// If you have functions addNewCamp, deleteCamp, searchByIqama etc. defined elsewhere previously, keep them.
// If not, simple placeholders so UI doesn't error (you can replace with your real implementations)
function addNewCamp(){ const name = (newCampName.value||'').trim(); if(!name) return alert('Enter camp name'); if(!camps.includes(name)) camps.push(name); apiSaveData().then(r=>{ if(r){ alert('Camp added'); updateCampDropdown(); renderAll(); } }); }
function deleteCamp(){ const name = (newCampName.value||'').trim(); if(!name) return alert('Enter camp name to delete'); const i=camps.indexOf(name); if(i>=0){ camps.splice(i,1); delete campData[name]; apiSaveData().then(r=>{ if(r){ alert('Camp deleted'); updateCampDropdown(); renderAll(); } }); } else alert('Camp not found'); }
function searchByIqama(){ const q = (searchIqama.value||'').trim(); if(!q) return alert('Enter IQAMA'); const found = workers.find(w=>w.iq===q); searchResult.innerText = found ? `${found.name} ‚Äî ${found.company} ‚Äî ${found.camp} ‚Äî Room ${found.room || ''}` : 'Not found'; }

// Optional worker column functions (if used)
function addWorkerColumn() {
  // Anyone can add now
  const table = document.querySelector("#tableWrap table");
  if(!table) return alert("No worker table found.");
  const headerRow = table.tHead.rows[0];
  const newTh = document.createElement("th");
  newTh.contentEditable = "true";
  newTh.innerText = "New Column";
  headerRow.appendChild(newTh);
  for(let r=0;r<table.tBodies[0].rows.length;r++){
    const cell = table.tBodies[0].rows[r].insertCell();
    cell.contentEditable = "true";
    cell.innerText = "";
  }
}

function deleteWorkerColumn() {
  // Anyone can delete now
  const table = document.querySelector("#tableWrap table");
  if(!table) return alert("No worker table found.");
  const colCount = table.tHead.rows[0].cells.length;
  if(colCount <= 2) return alert("Cannot delete essential columns.");
  for(let r=0;r<table.rows.length;r++){
    table.rows[r].deleteCell(colCount-1);
  }
}

function saveWorkerColumns(){
  // Anyone can save now
  const table = document.querySelector("#tableWrap table");
  if(!table) return alert("No table found.");
  const headers = Array.from(table.tHead.rows[0].cells).map(th => th.innerText.trim());
  const rows = [];
  for(let r=0;r<table.tBodies[0].rows.length;r++){
    const cells = Array.from(table.tBodies[0].rows[r].cells).map(td => td.innerText.trim());
    rows.push(cells);
  }
  campData.__workerColumns = {headers, rows};
  apiSaveData().then(r=>{
    if(r) alert("‚úÖ Columns saved successfully!");
    else alert("‚ö†Ô∏è Save failed.");
  });
}

const MASTER_PASSWORD = 'vddf2jjwm3x7p27frhrt8bvht'; // <-- set your desired password

  function verifyMaster() {
  const pw = document.getElementById('masterPw').value;
  const msg = document.getElementById('masterMsg');
  const ctrl = document.getElementById('masterControls');
  const hiddenSection = document.getElementById('masterHiddenSection');
  
  if (pw === MASTER_PASSWORD) {
    ctrl.classList.remove('hidden');
    hiddenSection.classList.remove('hidden');
    msg.innerText = "verified.";
    // Show Camp Summary controls when master verified
const campControls = document.getElementById('campControls');
if (campControls) campControls.classList.remove('hidden');

  } else {
    ctrl.classList.add('hidden');
    hiddenSection.classList.add('hidden');
    msg.innerText = "‚ùå Wrong master password!";
    // Hide Camp Summary controls when wrong password
const campControls = document.getElementById('campControls');
if (campControls) campControls.classList.add('hidden');

  }
}

function addCustomWorkerColumn() {
  const name = document.getElementById('newWorkerColName').value.trim();
  const msg = document.getElementById('newColMsg');
  if (!name) return alert("Enter a column name!");
  
  const table = document.querySelector("#tableWrap table");
  if (!table) {
    return alert("No worker table found!");
  }

  // Add header
  const headerRow = table.tHead.rows[0];
  const newTh = document.createElement("th");
  newTh.contentEditable = "true";
  newTh.innerText = name;
  headerRow.appendChild(newTh);

  // Add empty cells to all rows
  for (let r = 0; r < table.tBodies[0].rows.length; r++) {
    const cell = table.tBodies[0].rows[r].insertCell();
    cell.contentEditable = "true";
    cell.innerText = "";
  }

  // Save column immediately
  saveWorkerColumns();
  msg.innerText = `‚úÖ Column "${name}" added!`;
  document.getElementById('newWorkerColName').value = '';
}
// --- Loading Screen ---
window.addEventListener('load', () => {
  const loader = document.getElementById('loadingScreen');
  setTimeout(() => {
    loader.style.opacity = '0';
    loader.style.transition = 'opacity 0.6s ease';
    setTimeout(() => loader.remove(), 600);
  }, 1000); // 1 second
});

// initial load
loadData();
</script>
</body>
</html>
